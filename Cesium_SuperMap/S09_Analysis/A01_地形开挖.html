<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>地形开挖</title>
    <link href="../lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script type="text/javascript" src="../lib/Cesium/Cesium.js"></script>
    <script src="../lib/jQuery/jquery-3.2.1.min.js"></script>
    <script src="../lib/tooltip/tooltip.js"></script>
    <style>
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .tools {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: darkgray;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <div class="tools">
        <!-- 开挖深度 -->
        <label>开挖深度：<input type="text" name="depth" id="depth" value="100"></label><br>
        <label>抽出显示效果：<input type="checkbox" name="extract" id="extract" checked="false"></label><br>
        <label>抽出高度：<input type="text" name="extractHeight" id="extractHeight" value="300"></label><br>
        <label>hint：抽出高度要大于开挖深度才会看到抽取效果。</label><br>
        <button id="clear">清除</button>
    </div>
    <script type="text/javascript">

        // 初始化viewer部件，添加STK World Terrain地形服务
        const viewer = new Cesium.Viewer("cesiumContainer", {
            infoBox: false,
            terrainProvider: new Cesium.CesiumTerrainProvider({
                url: "https://www.supermapol.com/realspace/services/3D-stk_terrain/rest/realspace/datas/info/data/path",
                requestWaterMask: true,
                requestVertexNormals: true,
                isSct: false
            })
        });


        const scene = viewer.scene;

        viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
            // url: "http://mt1.google.cn/vt/lyrs=s&hl=zh-CN&x={x}&y={y}&z={z}&s=Gali" // 地址需要访问外网
            url: "https://gac-geo.googlecnapps.cn/maps/vt?lyrs=s&x={x}&y={y}&z={z}"
        }));

        // 设置相机视角
        viewer.scene.camera.setView({
            destination: new Cesium.Cartesian3(-1599896.7748115514, 5335128.546004026, 3110503.5731401895),
            orientation: {
                heading: 5.484961496987353,
                pitch: -0.2889694867297714,
                roll: 6.2831723532483075
            }
        });

        if (scene.pickPositionSupported) {
            terrainExcavation();
        } else {
            alert("不支持深度纹理,无法绘制多边形，地形开挖功能无法使用！");
        }



        /**
         * 地形开挖绘制
         * */
        function terrainExcavation() {
            // 绘制提示
            let tooltip = createTooltip(viewer._element);
            //绘制多边形
            let handlerPolygon = new Cesium.DrawHandler(viewer, Cesium.DrawMode.Polygon, 0);
            handlerPolygon.activeEvt.addEventListener(function (isActive) {
                if (isActive == true) {
                    viewer.enableCursorStyle = false;
                    viewer._element.style.cursor = "";
                    $("body").removeClass("drawCur").addClass("drawCur");
                } else {
                    viewer.enableCursorStyle = true;
                    $("body").removeClass("drawCur");
                }
            });
            handlerPolygon.movingEvt.addEventListener(function (windowPosition) {
                if (windowPosition.x < 200 && windowPosition.y < 150) {
                    tooltip.setVisible(false);
                    return;
                }
                if (handlerPolygon.isDrawing) {
                    tooltip.showAt(windowPosition, "<p>点击确定开挖区域中间点</p><p>右键单击结束绘制,进行开挖</p>");
                } else {
                    tooltip.showAt(windowPosition, "<p>点击绘制开挖区域第一个点</p>");
                }
            });
            handlerPolygon.drawEvt.addEventListener(function (result) {
                if (!result.object.positions) {
                    tooltip.showAt(result, "<p>请绘制正确的多边形</p>");
                    handlerPolygon.polygon.show = false;
                    handlerPolygon.polyline.show = false;
                    handlerPolygon.deactivate();
                    handlerPolygon.activate();
                    return;
                };
                let array = [].concat(result.object.positions);
                tooltip.setVisible(false);
                let positions = [];
                for (let i = 0, len = array.length; i < len; i++) {
                    let cartographic = Cesium.Cartographic.fromCartesian(array[i]);
                    let longitude = Cesium.Math.toDegrees(cartographic.longitude);
                    let latitude = Cesium.Math.toDegrees(cartographic.latitude);
                    let h = cartographic.height;
                    if (positions.indexOf(longitude) == -1 && positions.indexOf(latitude) == -1) {
                        positions.push(longitude);
                        positions.push(latitude);
                        positions.push(h);
                    }
                }
                let dep = $("#depth").val() || 500;
                let isExtract = $("#extract").prop("checked");
                let extractHeight = Number($("#extractHeight").val());
                viewer.scene.globe.removeAllExcavationRegion();
                viewer.scene.globe.removeAllExtractRegion();
                if (isExtract) {
                    addExtractRegion(positions, dep, extractHeight);
                } else {
                    addExcavationRegion(positions, dep);
                }
                handlerPolygon.polygon.show = false;
                handlerPolygon.polyline.show = false;
                handlerPolygon.deactivate();
                handlerPolygon.activate();
            });

            // 添加开挖区域
            function addExcavationRegion(positions, dep) {
                viewer.scene.globe.addExcavationRegion({
                    name: "ExcavationRegion",
                    position: positions,
                    height: dep,
                    transparent: false
                });
            }

            /**
             * 地形开挖抽出显示效果
             */
            function addExtractRegion(positions, dep, extractHeight) {
                console.log("positions", positions);
                viewer.scene.globe.addExtractRegion({
                    name: "ExtractRegion", // 名称
                    position: positions, // 区域
                    height: dep, // 开挖深度
                    transparent: false, // 封边是否透明
                    extractHeight: extractHeight, // 抽出高度
                    granularity: 1 // 精度
                });
            }



            handlerPolygon.activate();

            // 清除绘制
            document.getElementById("clear").onclick = function () {
                viewer.scene.globe.removeAllExcavationRegion();
                viewer.scene.globe.removeAllExtractRegion();
                handlerPolygon.polygon.show = false;
                handlerPolygon.polyline.show = false;
            };
        }
    </script>
</body>

</html>