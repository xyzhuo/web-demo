<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>动态单体化</title>
    <!-- 引入本地的cesium支持js和css文件，更快并节约流量 -->
    <link href="../../lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="../../lib/Cesium/Cesium.js"></script>
    <!-- <link href="./lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="./lib/Cesium/Cesium.js"></script> -->
    <script src="../../lib/iServerQuery/SuperMap-7.1-11828.js"></script>
    <script src="../../lib/jQuery/jquery-3.2.1.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #attrInfo {
            z-index: 999;
            position: absolute;
            top: 150px;
            right: 50px;
            background-color: skyblue;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            display: none;
        }
        
        table {
            /*把单元格间隙设置为0*/
            border-spacing: 0;
            /* 设置单元格的边框合并为1 */
            border-collapse: collapse;
        }
        
        tr {
            border: 1px solid slategray;
        }
        
        tr td {
            padding: 5px;
        }
        
        tr td:nth-child(1) {
            text-align: center;
            border-right: 1px solid slategray;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <!-- 属性信息 -->
    <div id="attrInfo">
        <h3>属性</h3>
        <table id="attrInfoTable">
            <tr>
                <td>abc</td>
                <td>abc</td>
            </tr>
        </table>
    </div>
    <script>
        let viewer = new Cesium.Viewer("cesiumContainer", {
            infoBox: false,
            navigation: false
        });

        let scene = viewer.scene;
        // 加载倾斜摄影图层
        let url = "http://www.supermapol.com/realspace/services/3D-dynamicDTH/rest/realspace/datas/Config%20-%201/config";
        let promise = scene.addS3MTilesLayerByScp(url, {
            name: "oblique photography"
        });

        promise.then(function(obliqueLayers) {
            // 定位到模型倾斜
            viewer.camera.setView({
                destination: new Cesium.Cartesian3(-2623004.4174251584, 3926981.958360567, 4287374.829655093),
                orientation: {
                    heading: 4.39611370540786,
                    pitch: -0.43458664812464143,
                    roll: 2.0174972803488345e-11
                }
            });;

            let handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
            handler.setInputAction(function(e) {

                // 清空属性表中的元素
                $("#attrInfo").hide();

                // 获取点击位置笛卡尔坐标
                let position = scene.pickPosition(e.position);
                if (!position) {
                    position = Cesium.Cartesian3.fromDegrees(0, 0, 0);
                }
                // 从笛卡尔坐标获取经纬度
                let cartographic = Cesium.Cartographic.fromCartesian(position);
                let longitude = Cesium.Math.toDegrees(cartographic.longitude);
                let latitude = Cesium.Math.toDegrees(cartographic.latitude);
                // let height = cartographic.height;
                console.log(`x: ${longitude}, y: ${latitude}`);

                doQuery({ // 查询点对象
                    x: longitude,
                    y: latitude
                });
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        });

        /**
         * 根据拾取的位置坐标{x:112, y:23}执行查询
         * */
        function doQuery(queryPoint) {
            // 查询服务地址
            const queryUrl = "http://www.supermapol.com/realspace/services/data-dynamicDTH/rest/data/featureResults.rjson?returnContent=true";
            // 查询参数
            const queryObj = {
                getFeatureMode: "SPATIAL",
                spatialQueryMode: "INTERSECT",
                datasetNames: ["铁岭矢量面:New_Region3D_1"], // 查询数据集信息
                geometry: {
                    id: 0,
                    parts: [1],
                    points: [queryPoint], // 查询的位置
                    type: "POINT"
                }
            };

            // 发送请求执行查询
            $.ajax({
                type: "post",
                url: queryUrl,
                data: JSON.stringify(queryObj), // 转化为JSON字符串作为查询参数,
                success: function(result) {
                    const resultObj = JSON.parse(result);
                    console.log("resultObj", resultObj);

                    // 清除所有的Entity，如果有其他业务性的Entity，需要定向清除viewer.entities.remove();
                    viewer.entities.removeAll();

                    if (!(resultObj && resultObj.featureCount > 0)) {
                        console.log("查询结果为空");
                        return;
                    }
                    onCompleted(resultObj.features[0]);
                },
                error: errorInfo => {
                    console.error("查询失败，错误信息", errorInfo);
                }
            })

        }


        /**
         * 高亮查询结果、属性信息
         * */
        function onCompleted(selectedFeature) {
            if (!selectedFeature) {
                return;
            }

            // 构建高亮矢量面
            let points3D = []; // [经度, 纬度, 经度, 纬度, ...]的形式，存放楼层面上的点坐标
            for (let pt of selectedFeature.geometry.points) {
                points3D.push(pt.x, pt.y);
            }
            viewer.entities.add({
                polygon: {
                    hierarchy: Cesium.Cartesian3.fromDegreesArray(points3D),
                    material: new Cesium.Color(223 / 255, 199 / 255, 0 / 255, 0.4)
                },
                classificationType: Cesium.ClassificationType.S3M_TILE // 贴在S3M模型表面
            });

            // 处理属性信息
            // console.log("fieldNames：", selectedFeature.fieldNames);
            // console.log("fieldValues：", selectedFeature.fieldValues);
            const attrInfo = [];
            $("#attrInfoTable").empty(); // 将原有属性表清空
            $("#attrInfo").animate({
                scrollTop: 0 // 滚动条复位
            });
            for (const index in selectedFeature.fieldNames) {
                attrInfo.push({
                    fieldName: selectedFeature.fieldNames[index],
                    fieldValue: selectedFeature.fieldValues[index]
                });
                $("#attrInfoTable").prepend(`<tr><td>${selectedFeature.fieldNames[index]}</td><td>${selectedFeature.fieldValues[index]}</td></tr>`);
            }
            // 显示属性表
            $("#attrInfo").show();
            console.log("attrInfo", attrInfo);
        }
    </script>
</body>

</html>