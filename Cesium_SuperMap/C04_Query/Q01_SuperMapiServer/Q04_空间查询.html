<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>空间查询</title>
    <!-- 引入本地的cesium支持js和css文件，更快并节约流量 -->
    <link href="../../lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="../../lib/Cesium/Cesium.js"></script>
    <!-- <link href="./lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="./lib/Cesium/Cesium.js"></script> -->
    <script src="../../lib/iServerQuery/SuperMap-7.1-11828.js"></script>
    <script src="../../lib/jQuery/jquery-3.2.1.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #attrInfo {
            z-index: 999;
            position: absolute;
            top: 150px;
            right: 50px;
            background-color: skyblue;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            display: none;
        }
        
        table {
            /*把单元格间隙设置为0*/
            border-spacing: 0;
            /* 设置单元格的边框合并为1 */
            border-collapse: collapse;
        }
        
        tr {
            border: 1px solid slategray;
        }
        
        tr td {
            padding: 5px;
        }
        
        tr td:nth-child(1) {
            text-align: center;
            border-right: 1px solid slategray;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <!-- 属性信息 -->
    <div id="attrInfo">
        <h3>属性</h3>
        <table id="attrInfoTable">
            <!-- <tr>
                <td>abc</td>
                <td>abc</td>
            </tr> -->
        </table>
    </div>
    <script>
        let viewer = new Cesium.Viewer("cesiumContainer", {
            infoBox: false,
            navigation: false
        });

        // const queryUrl = "http://localhost:8090/iserver/services/data-queryDB/rest/data";
        const queryUrl = "http://192.168.252.116:8190/iserver/services/data-FCFH/rest/data";
        // const queryUrl = "http://192.168.252.116/iserver/services/data-queryDB/rest/data";

        doSPATIALQuery(queryUrl, ["FCFH:楼栋数据"])

        function doSPATIALQuery(queryUrl, datasetNames) {
            // 查询参数
            const queryObj = {
                "getFeatureMode": "SPATIAL",
                "spatialQueryMode": "CONTAIN",
                "datasetNames": datasetNames,
                "geometry": {
                    // "points": [{
                    //     "x": 113.21618158339544,
                    //     "y": 23.397881366974733
                    // }, {
                    //     "x": 113.21623467983241,
                    //     "y": 23.397604149889386
                    // }, {
                    //     "x": 113.21652354415444,
                    //     "y": 23.397658880730933
                    // }],
                    "points": [{
                        "x": 113.214988800964,
                        "y": 23.4148269490405
                    }, {
                        "x": 113.225825520187,
                        "y": 23.4139618327999
                    }, {
                        "x": 113.215990514505,
                        "y": 23.4062213190686
                    }],
                    "type": "REGION"
                }
            };

            // 发送请求执行查询
            $.ajax({
                type: "post",
                url: queryUrl + "/featureResults.rjson?returnContent=true",
                data: JSON.stringify(queryObj), // 转化为JSON字符串作为查询参数,
                success: function(result) {
                    const resultObj = JSON.parse(result);
                    console.log("resultObj", resultObj);

                    // 清除所有的Entity，如果有其他业务性的Entity，需要定向清除viewer.entities.remove();
                    viewer.entities.removeAll();

                    if (!(resultObj && resultObj.featureCount > 0)) {
                        console.log("查询结果为空");
                        return;
                    }

                    for (const selectedFeature of resultObj.features) {
                        // const selectedFeature = result.originResult.features[0];

                        // 构建高亮矢量面
                        let points3D = []; // [经度, 纬度, 经度, 纬度, ...]的形式，存放楼层面上的点坐标
                        for (let pt of selectedFeature.geometry.points) {
                            points3D.push(pt.x, pt.y);
                        }
                        viewer.entities.add({
                            polygon: {
                                hierarchy: Cesium.Cartesian3.fromDegreesArray(points3D),
                                material: new Cesium.Color(223 / 255, 199 / 255, 0 / 255, 0.4)
                            },
                            classificationType: Cesium.ClassificationType.S3M_TILE // 贴在S3M模型表面
                        });
                    }

                    viewer.flyTo(viewer.entities);
                },
                error: errorInfo => {
                    console.error("查询失败，错误信息", errorInfo);
                }
            })
        }


        // doSqlQuery(`1=1`, url, ["FCFH:楼栋数据"]);

        /**
         * 执行SQL查询
         * 这里可根据需要自己请求工具封装
         * @param SQL SQL查询条件
         */
        function doSqlQuery(SQL, url, datasetNames) {
            console.log("SQL", SQL);
            var getFeatureParam, getFeatureBySQLService, getFeatureBySQLParams;
            getFeatureParam = new SuperMap.REST.FilterParameter({
                attributeFilter: SQL
            });
            getFeatureBySQLParams = new SuperMap.REST.GetFeaturesBySQLParameters({
                queryParameter: getFeatureParam,
                toIndex: -1,
                datasetNames: datasetNames // 本例中“户型面”为数据源名称，“专题户型面2D”为楼层面相应的数据集名称
            });
            // var url = "http://www.supermapol.com/realspace/services/data-FCFH_Shangdong/rest/data"; // 数据服务地址
            getFeatureBySQLService = new SuperMap.REST.GetFeaturesBySQLService(url, {
                eventListeners: {
                    // 查询成功时的回调函数
                    processCompleted: result => {
                        console.log("result", result);

                        // 清除所有的Entity，如果有其他业务性的Entity，需要定向清除viewer.entities.remove();
                        viewer.entities.removeAll();

                        if (result && result.originResult && result.originResult.featureCount < 1) {
                            console.log("查询结果为空");
                            return;
                        }

                        for (const selectedFeature of result.originResult.features) {
                            // const selectedFeature = result.originResult.features[0];

                            // 构建高亮矢量面
                            let points3D = []; // [经度, 纬度, 经度, 纬度, ...]的形式，存放楼层面上的点坐标
                            for (let pt of selectedFeature.geometry.points) {
                                points3D.push(pt.x, pt.y);
                            }
                            viewer.entities.add({
                                polygon: {
                                    hierarchy: Cesium.Cartesian3.fromDegreesArray(points3D),
                                    material: new Cesium.Color(223 / 255, 199 / 255, 0 / 255, 0.4)
                                },
                                classificationType: Cesium.ClassificationType.S3M_TILE // 贴在S3M模型表面
                            });
                        }

                        viewer.flyTo(viewer.entities);


                        // // 处理属性信息
                        // // console.log("fieldNames：", selectedFeature.fieldNames);
                        // // console.log("fieldValues：", selectedFeature.fieldValues);
                        // const attrInfo = [];
                        // $("#attrInfoTable").empty(); // 将原有属性表清空
                        // // 滚动条复位
                        // $("#attrInfo").animate({
                        //     scrollTop: 0
                        // });
                        // for (const index in selectedFeature.fieldNames) {
                        //     attrInfo.push({
                        //         fieldName: selectedFeature.fieldNames[index],
                        //         fieldValue: selectedFeature.fieldValues[index]
                        //     });
                        //     $("#attrInfoTable").prepend(`<tr><td>${selectedFeature.fieldNames[index]}</td><td>${selectedFeature.fieldValues[index]}</td></tr>`);
                        // }
                        // // 显示属性表
                        // $("#attrInfo").show();
                        // console.log("attrInfo", attrInfo);
                    },
                    // 查询失败时的回调函数
                    processFailed: errorInfo => {
                        console.error("查询失败，错误信息", errorInfo);
                    }
                }
            });
            getFeatureBySQLService.processAsync(getFeatureBySQLParams);
        }
    </script>
</body>

</html>