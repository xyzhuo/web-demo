<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>平面场景</title>

    <!-- 本地引入依赖 -->
    <link href="../lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="../lib/Cesium/Cesium.js"></script>

    <script src="../lib/iServerQuery/SuperMap-7.1-11828.js"></script>

    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
        }

        .tools {
            position: absolute;
            top: 20px;
            left: 20px;
            border: 1px solid rgb(6, 168, 231);
            padding: 10px;
        }

        .tools>div {
            height: 35px;
        }

        .tools>p {
            background-color: #adf;
        }

        div>label {
            background-color: #adf;
            padding: 5px;
            margin: 5px;
        }

        div>button {
            background-color: #adf;
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>

    <script type="text/javascript">
        /**
         * 参考文档：
         * （1）创建平面场景
         * https://blog.csdn.net/supermapsupport/article/details/89681589
         * https://www.jianshu.com/p/863fafe55cc7?tdsourcetag=s_pcqq_aiomsg
         * （2）平面场景
         * https://blog.csdn.net/supermapsupport/article/details/121418117
         *
         * 坐标拾取
         * https://blog.csdn.net/qq_38870665/article/details/112299972
         * */
        let viewer = new Cesium.Viewer("cesiumContainer", {
            infoBox: false
        });
        let scene = viewer.scene; // viewer.sceneMode = Cesium.SceneMode.COLUMBUS_VIEW;
        scene.mode = Cesium.SceneMode.COLUMBUS_VIEW; // 设置为哥伦布模式
        viewer.imageryLayers._layers[0].show = false; // 隐藏默认背景图层
        scene.globe.baseColor = Cesium.Color.WHITE;


        let imglayer = viewer.imageryLayers.addImageryProvider(new Cesium.SuperMapImageryProvider({
            url: "http://localhost:8090/iserver/services/map-ugcv5-2020WPCGCS2000ZW2V2014gz2000x/rest/maps/2020WP_CGCS2000_ZW2_V2014_gz2000x_设置广州规自局比例尺"
        }));

        // scene.open("http://localhost:8090/iserver/services/3D-hpjx/rest/realspace").then(layers => {
        //     console.log("layers", layers);
        //     // flyToGZ();
        // })

        scene.open("http://localhost:8090/iserver/services/3D-dxc/rest/realspace").then(layers => {
            console.log("layers", layers);
            // flyToGZ();

            addSceneEvent();
        })

        // let sql = `bottom < ${height} and ${height} < (bottom + LSG) and ${longitude} > SmSdriW and ${longitude} < SmSdriE and ${latitude} > SmSdriS and ${latitude} < SmSdriN`;
        let sql = `bottom < 62.22104310511274 and 62.22104310511274 < (bottom + LSG) and ${longitude} > SmSdriW and ${longitude} < SmSdriE and ${latitude} > SmSdriS and ${latitude} < SmSdriN`;


        function addSceneEvent() {
            var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);

            //左键点击，添加点
            handler.setInputAction(function (e) {
                var pickPosition = viewer.scene.pickPositionWorldCoordinates(e.position);
                var position = new Cesium.Cartesian3(pickPosition.y, pickPosition.z, pickPosition.x);
                console.log("position", position);

            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }

        function addScenePoint() {
            var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);

            //左键点击，添加点
            handler.setInputAction(function (e) {
                var position = viewer.scene.pickPositionWorldCoordinates(e.position);
                console.log("position", position);
                var position1 = new Cesium.Cartesian3(position.y, position.z, position.x);
                console.log("position1", position1);
                var p1 = Cesium.SceneTransforms.convert2DToCartesian(scene, position1);
                console.log(p1);

                //在点击位置添加对应点
                var entity1 = viewer.entities.add(new Cesium.Entity({
                    point: new Cesium.PointGraphics({
                        color: new Cesium.Color(1, 1, 0),
                        pixelSize: 10,
                        // outlineColor: new Cesium.Color(0, 1, 1)
                    }),
                    position: p1
                }));
                viewer.flyTo(entity1);

            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }


        function flyToGZ() {

            let point = new Cesium.Cartesian3(79814.20432301628, 239601.87928034933, 285188.58983803046);
            let pointCartographic = scene.camera._projection.unproject(point);
            let pointCX = Cesium.Math.toDegrees(pointCartographic.longitude);
            let pointCY = Cesium.Math.toDegrees(pointCartographic.latitude);

            // 设置相机位置，定位至模型
            scene.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(pointCX, pointCY, pointCartographic.height),
                orientation: {
                    heading: 4.4231285301066237e-13,
                    pitch: -1.5707963267948966,
                    roll: 0
                }
            });
        }
    </script>
</body>

</html>