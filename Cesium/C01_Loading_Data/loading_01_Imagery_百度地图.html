<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>加载百度地图服务</title>

    <!-- 本地引入依赖 -->
    <link href="../lib/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="../lib/Cesium/Cesium.js"></script>

    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>

    <!-- 百度地图提供者： https://blog.csdn.net/KaiSarH/article/details/106242572 -->
    <script type="text/javascript">
        var viewer;

        viewer = new Cesium.Viewer("cesiumContainer", {
            infoBox: false
        });
        let scene = viewer.scene;
        // scene.debugShowFramesPerSecond = true; //显示帧率，默认不显示

        /************************************************************************************************************************************
         *
         * 自定义百度影像提供者加载百度地图：BaiduImageryProvider()
         *
         ************************************************************************************************************************************/
        Cesium.BaiduImageryProvider = function (options) {
            this._errorEvent = new Cesium.Event();
            this._tileWidth = 256;
            this._tileHeight = 256;
            this._maximumLevel = 18;
            this._minimumLevel = 1;
            let southwestInMeters = new Cesium.Cartesian2(-33554054, -33746824);
            let northeastInMeters = new Cesium.Cartesian2(33554054, 33746824);
            this._tilingScheme = new Cesium.WebMercatorTilingScheme({
                rectangleSouthwestInMeters: southwestInMeters,
                rectangleNortheastInMeters: northeastInMeters
            });
            this._rectangle = this._tilingScheme.rectangle;
            this._resource = Cesium.Resource.createIfNeeded(options.url);
            this._tileDiscardPolicy = undefined;
            this._credit = undefined;
            this._readyPromise = undefined;
        };

        Object.defineProperties(Cesium.BaiduImageryProvider.prototype, {
            url: {
                get: function () {
                    return this._resource.url;
                }
            },
            proxy: {
                get: function () {
                    return this._resource.proxy;
                }
            },
            tileWidth: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('tileWidth must not be called before the imagery provider is ready.');
                    }
                    return this._tileWidth;
                }
            },

            tileHeight: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('tileHeight must not be called before the imagery provider is ready.');
                    }
                    return this._tileHeight;
                }
            },

            maximumLevel: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('maximumLevel must not be called before the imagery provider is ready.');
                    }
                    return this._maximumLevel;
                }
            },

            minimumLevel: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('minimumLevel must not be called before the imagery provider is ready.');
                    }
                    return this._minimumLevel;
                }
            },

            tilingScheme: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('tilingScheme must not be called before the imagery provider is ready.');
                    }
                    return this._tilingScheme;
                }
            },

            tileDiscardPolicy: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('tileDiscardPolicy must not be called before the imagery provider is ready.');
                    }
                    return this._tileDiscardPolicy;
                }
            },

            rectangle: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('rectangle must not be called before the imagery provider is ready.');
                    }
                    return this._rectangle;
                }
            },

            errorEvent: {
                get: function () {
                    return this._errorEvent;
                }
            },
            ready: {
                get: function () {
                    return this._resource;
                }
            },
            readyPromise: {
                get: function () {
                    return this._readyPromise;
                }
            },
            credit: {
                get: function () {
                    if (!this.ready) {
                        throw new Cesium.DeveloperError('credit must not be called before the imagery provider is ready.');
                    }
                    return this._credit;
                }
            },
        });

        Cesium.BaiduImageryProvider.prototype.requestImage = function (x, y, level, request) {
            let xTileCount = this._tilingScheme.getNumberOfXTilesAtLevel(level);
            let yTileCount = this._tilingScheme.getNumberOfYTilesAtLevel(level);
            let url = this.url
                .replace("{x}", x - xTileCount / 2)
                .replace("{y}", yTileCount / 2 - y - 1)
                .replace("{z}", level)
                .replace("{s}", Math.floor(10 * Math.random()));
            console.log("zxy:" + level + ", " + x + ", " + y + "; " + url);
            return Cesium.ImageryProvider.loadImage(this, url);
        };

        let baiduImageryProvider = new Cesium.BaiduImageryProvider({
            url: "http://online{s}.map.bdimg.com/onlinelabel/?qt=tile&x={x}&y={y}&z={z}&styles=pl&scaler=1&p=1"
        });

        viewer.imageryLayers.addImageryProvider(baiduImageryProvider);

        /*****************************************************************************************************************************
         *
         * 使用iServer转发后的加载方式（建议使用BaiduImageryProvider()的方式）
         *
         *****************************************************************************************************************************/
        // let url = "http://106.15.40.105:8090/iserver/services/map-baidu/rest/maps/normal";
        // let normalImageryProvider = new Cesium.SuperMapImageryProvider({
        //     url: url
        // });
        // viewer.imageryLayers.addImageryProvider(normalImageryProvider);

        // 叠加天地图
        // let url = "http://106.15.40.105:8090/iserver/services/map-tianditu/rest/maps/影像中文注记_经纬度";
        // let normalImageryProvider = new Cesium.SuperMapImageryProvider({
        //     url: url
        // });
        // viewer.imageryLayers.addImageryProvider(normalImageryProvider);
    </script>
</body>

</html>