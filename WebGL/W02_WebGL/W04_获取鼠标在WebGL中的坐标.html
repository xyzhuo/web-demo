<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>获取鼠标在WebGL中点击的位置</title>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script id="vertexShader" type="x-shader/x-vertex">
        // 定义一个attribute变量，接收顶点的位置
        attribute vec4 a_Position;
        void main() {
            gl_Position = a_Position; // 顶点使用 接收到的外部顶点的位置
            gl_PointSize = 20.0; // 顶点大小
        }
    </script>
    <script id="fragmentShader" type="x-shader/x-fragment">
        void main() {
            gl_FragColor = vec4(0.9, 1.0, 0.2, 1.0); // 顶点颜色
        }
    </script>
    <script type="module">
        import { initShaders } from "./lib/WebglUtil.js";


        /** @type {HTMLCanvasElement} */
        const canvas = document.getElementById("canvas");
        const gl = canvas.getContext("webgl");

        // 清空绘制面板
        gl.clearColor(0.2, 0.2, 0.5, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);


        // 对画布绑定监听事件
        canvas.addEventListener("click", event => {
            console.log("event", event);
            // 获取鼠标点击位置的坐标
            const { clientX, clientY } = event;
            console.log("clientX, clientY = ", clientX, clientY);
            // 获取Canvas在网页中的位置
            const { left, top } = canvas.getBoundingClientRect();
            console.log("left, top = ", left, top);

            // 获取到鼠标在Canvas的坐标
            const [cssX, cssY] = [clientX - left, clientY - top];
            console.log("cssX, cssY = ", cssX, cssY);

            // 将Canvas的坐标转换为WebGL坐标
            // 获取Canvas的宽、高
            const { width, height } = canvas.getBoundingClientRect();
            // canvas 画布中心的位置
            const [halfWidth, halfHeight] = [width / 2, height / 2];
            // 鼠标基于画布中心的位置
            const [xBaseCenter, yBaseCenter] = [cssX - halfWidth, cssY - halfHeight];
            console.log("xBaseCenter, yBaseCenter = ", xBaseCenter, yBaseCenter);

            // 解决 y 方向的差异：因为webgl的y轴与 Canvas 2d的y轴方向相反
            const yBaseCenterTop = -yBaseCenter;

            // 解决坐标基底的差异, canvas的平面坐标系 ==> webgl缩放坐标系
            const [x, y] = [xBaseCenter / halfWidth, yBaseCenterTop / halfHeight];
            console.log("x, y = ", x, y);

        });


        // 获取到顶点着色器、片元着色器的文本。
        const vsSource = document.getElementById("vertexShader").innerText;
        const fsSource = document.getElementById("fragmentShader").innerText;

        // 将代码加载到程序中
        const program = initShaders(gl, vsSource, fsSource);

        // 获取attribute变量
        const a_Position = gl.getAttribLocation(program, "a_Position");
        console.log("a_Position", a_Position);

        // 对attribute传递变量
        gl.vertexAttrib3f(a_Position, 0.0, 0.5, 0.0);

        // 绘制顶点
        gl.drawArrays(gl.POINTS, 0, 1);
    </script>
</body>

</html>