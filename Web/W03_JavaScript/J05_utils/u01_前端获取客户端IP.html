<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端获取客户端IP</title>
    <script src="../lib/jQuery/jquery-3.2.1.min.js"></script>
</head>

<body>

    <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script>
        // getNetworkIp();
        function getNetworkIp() {
            document.write(returnCitySN["cip"] + ',' + returnCitySN["cname"]);
        }

        // getUserIP(result => {
        //     console.log("result", result);
        // });

        function getUserIP(callback) {
            let recode = {};
            let RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
            // 如果不存在则使用一个iframe绕过
            if (!RTCPeerConnection) {
                // 因为这里用到了iframe，所以在调用这个方法的script上必须有一个iframe标签
                // <iframe id="iframe" sandbox="allow-same-origin" style="display:none;"></iframe>
                let win = iframe.contentWindow;
                RTCPeerConnection = win.RTCPeerConnection || win.mozRTCPeerConnection || win.webkitRTCPeerConnection;
            }

            //创建实例，生成连接
            let pc = new RTCPeerConnection();

            // 匹配字符串中符合ip地址的字段
            function handleCandidate(candidate) {
                console.log("candidate：", candidate);
                let ip_regexp = /([0-9]{1,3}(\.[0-9]{1,3}){3}|([a-f0-9]{1,4}((:[a-f0-9]{1,4}){7}|:+[a-f0-9]{1,4}){6}))/;
                let ip_isMatch = candidate.match(ip_regexp)[1];
                if (!recode[ip_isMatch]) {
                    callback(ip_isMatch);
                    recode[ip_isMatch] = true;
                }
            }

            //监听icecandidate事件
            pc.onicecandidate = (ice) => {
                console.log("ice", ice);
                if (ice.candidate) {
                    handleCandidate(ice.candidate.candidate);
                }
            };
            //建立一个伪数据的通道
            pc.createDataChannel('');
            pc.createOffer((res) => {
                pc.setLocalDescription(res);
            }, () => {});

            //延迟，让一切都能完成
            setTimeout(() => {
                let lines = pc.localDescription.sdp.split('\n');
                lines.forEach(item => {
                    if (item.indexOf('a=candidate:') === 0) {
                        handleCandidate(item);
                    }
                })
            }, 1000);
        }

        // getYourIP();

        function getYourIP() {
            var RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
            if (RTCPeerConnection)(function() {
                var rtc = new RTCPeerConnection({
                    iceServers: []
                });
                if (1 || window.mozRTCPeerConnection) {
                    rtc.createDataChannel('', {
                        reliable: false
                    });
                };

                rtc.onicecandidate = function(evt) {
                    if (evt.candidate) grepSDP("a=" + evt.candidate.candidate);
                };
                rtc.createOffer(function(offerDesc) {
                    grepSDP(offerDesc.sdp);
                    rtc.setLocalDescription(offerDesc);
                }, function(e) {
                    console.warn("offer failed", e);
                });


                var addrs = Object.create(null);
                addrs["0.0.0.0"] = false;

                function updateDisplay(newAddr) {
                    console.log("newAddr", newAddr);
                    if (newAddr in addrs) return;
                    else addrs[newAddr] = true;
                    var displayAddrs = Object.keys(addrs).filter(function(k) {
                        return addrs[k];
                    });
                    for (var i = 0; i < displayAddrs.length; i++) {
                        if (displayAddrs[i].length > 16) {
                            displayAddrs.splice(i, 1);
                            i--;
                        }
                    }
                    console.log(displayAddrs[0]);
                }

                function grepSDP(sdp) {
                    var hosts = [];
                    sdp.split('\r\n').forEach(function(line, index, arr) {
                        if (~line.indexOf("a=candidate")) {
                            var parts = line.split(' '),
                                addr = parts[4],
                                type = parts[7];
                            if (type === 'host') updateDisplay(addr);
                        } else if (~line.indexOf("c=")) {
                            var parts = line.split(' '),
                                addr = parts[2];
                            updateDisplay(addr);
                        }
                    });
                }
            })();
            else {
                console.log("请使用主流浏览器：chrome,firefox,opera,safari");
            }
        }

        getRef();

        function getRef() {
            var _typeForm = null;
            $(document).ready(function() {
                var curUrl = document.location.href; //当前url
                if (/MSIE (d+.d+);/.test(navigator.userAgent) || /MSIE(d+.d+);/.test(navigator.userAgent)) { //IE情况下
                    var referLink = document.createElement('a');
                    referLink.href = curUrl;
                    document.body.appendChild(referLink);
                    // referLink.click();
                } else {
                    // location.href = curUrl;
                }
                // 获取Referer从而获得typeForm
                var Referer = document.referrer;
                _typeForm = GetQueryString("typeForm", Referer);
                console.log("_typeForm：", Referer, _typeForm);
            })

            //获取Referer参数的方法
            function GetQueryString(name, Referer) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = Referer.match(reg);
                if (r != null) return unescape(r[2]);
                return null;
            }
        }
    </script>
</body>

</html>